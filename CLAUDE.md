# 開発ガイドライン

このドキュメントには、このコードベースの操作に関する重要な情報が含まれています。これらのガイドラインに正確に従ってください。

## 開発ルール

1. パッケージ管理
    - uv だけを利用する、決して pip を利用しないこと
    - インストール: `uv add <package>`
    - ツールの実行: `uv run <tool>`
    - アップグレード: `uv lock --upgrade-package <package>`
    - 禁止事項: `uv pip install`, `@latest` syntax

2. コード品質
    - すべてのコードに型ヒントが必要
    - パブリックAPIには必ずドックストリング（Docstrings）を記述すること
    - 関数は単一の機能に集中させ、短く保つこと
    - 既存のパターンを厳格に遵守すること
    - 1行の長さは最大120文字まで
    - 禁止事項: 関数内でのインポート: インポート文は必ずファイルの先頭に記述すること

3. テスト要件
    - フレームワーク: `uv run pytest` を利用すること
    - 非同期テスト: asyncio ではなく anyio を使用すること
    - `Test` プリフィックスをつけたクラスは利用せず関数を利用すること
    - カバレッジ: エッジケースやエラー系もテストすること
    - 新機能にはテストを含めること
    - バグ修正には再発防止のための回帰テストを含めること
    - テストファイルの構成はソースツリーと対応させること: `src/aaa/bbb/some_file.py` → `tests/aaa/bbb/test_some_file.py`
        - 対象モジュールの既存ファイルにテストを追加すること

4. コミット規約

- **Conventional Commits** 形式: `<type>: <説明>` （日本語で記述）
- 使用可能なプリフィックス:
    - `feat`: 新機能
    - `fix`: バグ修正
    - `docs`: ドキュメントのみの変更
    - `style`: コードの意味に影響しない変更（空白、フォーマット等）
    - `refactor`: バグ修正でも機能追加でもないコード変更
    - `perf`: パフォーマンス改善
    - `test`: テストの追加・修正
    - `build`: ビルドシステムや外部依存に関する変更
    - `ci`: CI設定ファイルやスクリプトの変更
    - `chore`: その他の雑務（src・testに影響しない変更）
    - `revert`: 以前のコミットの取り消し

## Python ツール

## コードフォーマッタ

1. Ruff
    - フォーマット: `uv run ruff format .`
    - チェック: `uv run ruff check .`
    - 修正: `uv run ruff check . --fix`
    - 重要事項:
        - 1行の長さ (88文字)
        - インポートのソーティング (I001)
        - 未使用のインポートの削除
    - 改行ルール:
        - 文字列: 括弧`()`を使用すること
        - 関数呼び出し: 適切なインデントを用いて複数行に分けること
        - インポート: 可能な限り1行にまとめること

2. 型チェック
    - ツール: `uv run pyright`
    - 要件:
        - 文字列に対する型絞り込み (Type narrowing) を適切に行うこと
        - チェックがパスしていれば、バージョンに関する警告は無視してもよい

## エラー解決

1. CI (継続的インテグレーション) の失敗
    - 修正の優先順位:
        1. Formatting
        2. Type errors
        3. Linting
    - 型エラーへの対処:
        - 行の前後関係（コンテキスト）を十分に確認すること
        - Optional 型（None の可能性）をチェックすること
        - 型絞り込み (Type narrowing) を追加すること
        - 関数のシグネチャ (引数や戻り値の定義) を検証すること

2. よくある問題
    - 行の長さ:
        - 文字列は括弧`()`を使って分割すること
        - 関数呼び出しは複数行にする
        - インポート文も適宜分割する
    - 型:
        - None チェックを追加する
        - 文字列の型を絞り込む
        - 既存のパターンに合わせる

3. ベストプラクティス
    - コミット前に git status を確認すること
    - 型チェックを実行する前にフォーマッタを実行すること
    - 変更は最小限に留めること
    - 既存のパターンに従うこと
    - パブリックAPIにはドキュメント (Docstrings) を付与すること
    - 徹底的にテストを行うこと

## 例外処理

- **例外をキャッチした場合は、`logger.error()`ではなく、常に`logger.exception()`を使用すること**
    - メッセージの中に例外オブジェクトを含めないこと: `logger.exception(f"Failed: {e}")` ではなく
      `logger.exception("Failed")`
- 可能な限り**特定の例外を指定してキャッチすること**:
    - ファイル操作: `except (OSError, PermissionError):`
    - JSON: `except json.JSONDecodeError:`
    - ネットワーク: `except (ConnectionError, TimeoutError):`
- **禁止事項** `except Exception:` は厳禁、ただし、トップレベル (最上位) のハンドラーは除く
